<!DOCTYPE html>
<html lang="en">
    <head>
    <title>tuplain</title>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    </head>
    <style>
        #title {
            color:#fff;
        }
        body {
            background-color:#202021;
            color:#888;
            text-align: center;
        }
        
        #audioplayer {
            border: 5px solid black;
        }
        #status {
            font-family:monospace;
        }
        .container {
            width: 200px;
            clear: both;
        }
        .container input {
            width: 100%;
            clear: both;
        }
        .transport {
            margin: 8px;
            text-align: center;
        }
        .transport > button {
        }
    </style>
<body>
<div id="content">
<h1 id="title"></h1>

<div id="videoplayer">
    JavaScript is required
</div>
<div class="transport">
    <button id="play">&#9654; Play</button>
    <button id="play-fullscreen">&#9654; Play fullscreen</button>
</div>
<div id="audioplayer">
</div>
<br>

<span id="status">
Loading players...
</span>
</div>

<br>
<span>For help see the <a target="_blank" href="help.html">User's Guide</a></span>
</script>

<script>
(function($) {
    $.QueryString = (function(a) {
        if (a == "") return {};
        var b = {};
        for (var i = 0; i < a.length; ++i)
        {
            var p=a[i].split('=');
            if (p.length != 2) continue;
            b[p[0]] = decodeURIComponent(p[1].replace(/\+/g, " "));
        }
        return b;
    })(window.location.search.substr(1).split('&'))
})(jQuery);

function setStatus(msg) {
    $("#status").html(msg)
}


var args = {
    "video" : {
        videoid : "",
        start : 10,
        elementid : "videoplayer",
        width : "1280",
        height : "720",
        volume : 0,
        rate : 1.0
    },
    "audio" : {
        videoid : "",
            start : 0,
        elementid : "audioplayer",
        width: "400",
        height: "300",
        volume : 100,
        rate : 1.0
    },
    "lengthInSeconds" : 0.0
};

var audioId = $.QueryString["audio"] || $.QueryString["a"];
var videoId = $.QueryString["video"] || $.QueryString["v"];
console.log("audio id: " + audioId);
console.log("video id: " + videoId);

if (!(audioId && videoId)) {
    setStatus("Invalid video URL given.");
}

var pick = function(a, b, c) {
    for(var arg = 0; arg < arguments.length; arg++)
    {
        var v =  arguments[arg];
        if (typeof v != "undefined" && !isNaN(v)) {
            return v;
        }
    }

    return undefined;
}

args["video"].videoid = videoId;
args["audio"].videoid = audioId;

args["video"].start = pick($.QueryString["videostart"], $.QueryString["vstart"], $.QueryString["vs"], 0);
args["audio"].start = pick($.QueryString["audiostart"], $.QueryString["astart"], $.QueryString["as"], 0);
args["video"].rate = pick(parseFloat($.QueryString["vrate"]), parseFloat($.QueryString["vr"]), 1.0);
args["audio"].rate = pick(parseFloat($.QueryString["arate"]), parseFloat($.QueryString["ar"]), 1.0);
args["video"].volume = pick(parseInt($.QueryString["videovol"]), parseInt($.QueryString["vv"]), 0);
args["audio"].volume = pick(parseInt($.QueryString["audiovol"]), parseInt($.QueryString["av"]), 100);
args.lengthInSeconds = pick(parseFloat($.QueryString["len"]), parseFloat($.QueryString["l"]), 0);

var title = $.QueryString["title"] || "";
console.log("title", title);
document.getElementById("title").innerHTML = title;

console.log("video", args["video"]);
console.log("audio", args["audio"]);
console.log("length", args.lengthInSeconds);

// Load the IFrame Player API code asynchronously.
var tag = document.createElement('script');
tag.src = "https://www.youtube.com/player_api";
var firstScriptTag = document.getElementsByTagName('script')[0];
firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

var playClicked = false;

var players = {
    "video" : {},
    "audio" : {}
}

var state = {
    "video" : {loaded: false},
    "audio" : {loaded: false}
}

var transport = {
    "startTime" : 0,
    "playing" : false,
    "timer" : null
}


function checkTime() {
    
    if (args.lengthInSeconds == 0.0) {
        return;
    }
    
    var delta = (Date.now() - transport.startTime)/1000.0;
    console.log(delta);
    if (delta > args.lengthInSeconds) {
        players["audio"].stopVideo();
        players["video"].stopVideo();
        clearTimeout(args.timer);
    }
}

function canPlay() {
    return state["video"].loaded && state["audio"].loaded
}

function playVideos() {
    if (transport.playing) {
        return;
    }

    for (var name of Object.keys(players)) {
        players[name].playVideo();
    }

    transport.startTime = Date.now();
    transport.playing = true;

    if (args.lengthInSeconds > 0) {
        args.timer = setInterval(checkTime, 100);
        setStatus("Playing");
    }
}

function onYouTubePlayerAPIReady() {
    for (var name of Object.keys(players)) {
        if (!players.hasOwnProperty(name)) { continue; }

        console.log(args[name]);
        var config = args[name];
        players[name] = new YT.Player(config["elementid"], {
          width: config["width"],
          height: config["height"],
          videoId: config["videoid"],
          playerVars: {
              /*'autoplay': 1,*/
              'enablejsapi' : 1,
              'modestbranding' : 1,
              'start' : config["start"]
          },
          events : {
              onReady : function(event) {
                  var vid = event.target;
                  vid.setVolume(args[vid.name].volume);
                  vid.setPlaybackRate(args[vid.name].rate);
                  state[vid.name].loaded = true

                  if (canPlay()) {
                      setStatus("Videos loaded")
                  }

                  if (playClicked && canPlay()) {
                      playVideos();
                  }
              }
          }
        });

        // Attach the player name to the YT player element so we can easily access
        // them from the event handler.
        players[name].name = name;
    }
}

function makeFullscreen(e) {
    if (e.requestFullscreen) {
        e.requestFullscreen();
    } else if (e.webkitRequestFullscreen) {
        e.webkitRequestFullscreen();
    } else if (e.mozRequestFullScreen) {
        e.mozRequestFullScreen();
    } else if (e.msRequestFullscreen) {
        e.msRequestFullscreen();
    }
}

var handler = function(fullScreen) {
    return function() {
        playClicked = true;
        if (fullScreen) {
            makeFullscreen(document.getElementById("videoplayer"));
        }
        if (canPlay()) {
            // Add a 200 ms delay to allow the browser's transition to finish
            window.setTimeout(playVideos, 200);
        }
    }
}

var button = document.getElementById("play")
var button2 = document.getElementById("play-fullscreen")
button.addEventListener("click", handler(false));
button2.addEventListener("click", handler(true));
</script>

</body>
</html>


